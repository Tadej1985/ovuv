name: Update Coin Scores (Scheduled)

# --- 1. SET THE 8-HOUR SCHEDULE ---
on:
  # Cron expression: "At minute 0 past every 8th hour" (e.g., 00:00, 08:00, 16:00 UTC)
  # All times are UTC.
  schedule:
    - cron: '0 */8 * * *'
  # Allows manual triggering for testing
  workflow_dispatch:

jobs:
  update_scores:
    runs-on: ubuntu-latest
    
    # CRITICAL: Grant permission to commit and push changes back to the repository
    permissions:
      contents: write 

    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
        # Needed for the Git push step later
        with:
          fetch-depth: 0 

      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Ensure this matches your testing environment

      - name: 3. Install dependencies
        run: |
          # Install libraries needed for the script
          pip install pandas requests google-genai

      - name: 4. Run Coin Scoring Script (Fetch Data & Run Gemini Analysis)
        # Passes the sensitive API keys securely to the script
        env:
          COINCAPSECRET: ${{ secrets.COINCAPSECRET }} 
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/update_data.py  # Replace 'your_script_name.py'

      # --- 5. PERSIST CHANGES (Commit and Push) ---

      - name: 5. Configure Git identity
        run: |
          git config user.name "Automated Score Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: 6. Commit and Push new data.json
        run: |
          # Check if the docs/data.json file has actually been modified
          if git diff --exit-code docs/data.json; then
            echo "No changes detected in data.json. Skipping commit."
          else
            echo "Changes found. Committing and pushing new data.json..."
            git add docs/data.json
            git commit -m "Automated update: New coin scores (Gemini-Grounding)"
            git push
            echo "Successfully pushed update."
          fi
